#!/opt/homebrew/bin/python3.11
"""
Alpaca Trading CLI
A command-line interface for Alpaca trading operations
"""

import os
import sys
import argparse
from datetime import datetime, timedelta

try:
    from alpaca.trading.client import TradingClient
    from alpaca.trading.requests import MarketOrderRequest, GetOrdersRequest, GetPortfolioHistoryRequest, GetCalendarRequest
    from alpaca.trading.enums import OrderSide, TimeInForce, QueryOrderStatus
    from alpaca.data.historical import StockHistoricalDataClient
    from alpaca.data.requests import StockLatestQuoteRequest
except ImportError:
    print("Error: alpaca-py not installed")
    print("Install with: pip3 install alpaca-py")
    sys.exit(1)


def get_credentials():
    """Get API credentials from environment variables."""
    api_key = os.getenv('ALPACA_API_KEY')
    secret_key = os.getenv('ALPACA_SECRET_KEY')
    paper = os.getenv('ALPACA_PAPER', 'true').lower() == 'true'
    
    if not api_key or not secret_key:
        print("Error: Please set ALPACA_API_KEY and ALPACA_SECRET_KEY environment variables")
        print("\nRun 'alpaca auth' to configure your API keys")
        sys.exit(1)
    
    return api_key, secret_key, paper


def cmd_auth():
    """Interactive authentication setup."""
    print("Alpaca API Configuration")
    print("=" * 60)
    print("\nGet your API keys from: https://alpaca.markets")
    print("(Dashboard ‚Üí API Keys)\n")
    
    api_key = input("Enter API Key: ").strip()
    secret_key = input("Enter Secret Key: ").strip()
    
    print("\nTrading Mode:")
    print("1. Paper Trading (recommended for testing)")
    print("2. Live Trading (real money)")
    mode = input("Choose mode (1 or 2): ").strip()
    
    paper = "true" if mode == "1" else "false"
    
    # Detect shell
    shell_config = os.path.expanduser("~/.zshrc")
    if not os.path.exists(shell_config):
        shell_config = os.path.expanduser("~/.bashrc")
    if not os.path.exists(shell_config):
        shell_config = os.path.expanduser("~/.profile")
    
    # Append to shell config
    with open(shell_config, 'a') as f:
        f.write(f'\nexport ALPACA_API_KEY="{api_key}"\n')
        f.write(f'export ALPACA_SECRET_KEY="{secret_key}"\n')
        f.write(f'export ALPACA_PAPER="{paper}"\n')
    
    print(f"\n‚úì Configuration saved to {shell_config}")
    print("‚úì Restart your terminal or run: source", shell_config)


def cmd_clock():
    """Check market status."""
    api_key, secret_key, paper = get_credentials()
    client = TradingClient(api_key, secret_key, paper=paper)
    
    clock = client.get_clock()
    
    print("=" * 60)
    print("  MARKET STATUS")
    print("=" * 60)
    print()
    
    status = "üü¢ OPEN" if clock.is_open else "üî¥ CLOSED"
    print(f"Status: {status}")
    print(f"Current Time: {clock.timestamp}")
    print(f"Next Open: {clock.next_open}")
    print(f"Next Close: {clock.next_close}")
    print()
    print("=" * 60)


def cmd_calendar(days=30):
    """Show market calendar."""
    api_key, secret_key, paper = get_credentials()
    client = TradingClient(api_key, secret_key, paper=paper)
    
    start = datetime.now().date()
    end = start + timedelta(days=days)
    
    request = GetCalendarRequest(
        start=start,
        end=end
    )
    
    calendar = client.get_calendar(filters=request)
    
    print()
    print("=" * 60)
    print(f"  MARKET CALENDAR (Next {days} days)")
    print("=" * 60)
    print()
    
    for day in calendar:
        date_str = day.date.strftime("%Y-%m-%d %A")
        open_time = day.open.strftime("%H:%M")
        close_time = day.close.strftime("%H:%M")
        print(f"{date_str}")
        print(f"  Open: {open_time} ET  |  Close: {close_time} ET")
        print()
    
    print("=" * 60)


def cmd_history(period="1M", timeframe="1D"):
    """Show portfolio history."""
    api_key, secret_key, paper = get_credentials()
    client = TradingClient(api_key, secret_key, paper=paper)
    
    request = GetPortfolioHistoryRequest(
        period=period,
        timeframe=timeframe
    )
    
    history = client.get_portfolio_history(request)
    
    print()
    print("=" * 60)
    print(f"  PORTFOLIO HISTORY ({period}, {timeframe} bars)")
    print("=" * 60)
    print()
    
    if not history.equity or len(history.equity) == 0:
        print("No history data available")
        print()
        print("=" * 60)
        return
    
    start_equity = history.equity[0]
    end_equity = history.equity[-1]
    change = end_equity - start_equity
    change_pct = (change / start_equity * 100) if start_equity > 0 else 0
    
    print(f"Start Equity: ${start_equity:,.2f}")
    print(f"End Equity: ${end_equity:,.2f}")
    print(f"Change: ${change:+,.2f} ({change_pct:+.2f}%)")
    print()
    
    # Show last 10 data points
    print("Recent History (last 10 data points):")
    print()
    
    start_idx = max(0, len(history.equity) - 10)
    for i in range(start_idx, len(history.equity)):
        timestamp = datetime.fromtimestamp(history.timestamp[i])
        equity = history.equity[i]
        
        if i > 0:
            prev_equity = history.equity[i-1]
            daily_change = equity - prev_equity
            daily_change_pct = (daily_change / prev_equity * 100) if prev_equity > 0 else 0
            change_str = f"${daily_change:+,.2f} ({daily_change_pct:+.2f}%)"
        else:
            change_str = "‚Äî"
        
        print(f"{timestamp.strftime('%Y-%m-%d %H:%M')}: ${equity:,.2f}  {change_str}")
    
    print()
    print("=" * 60)


def cmd_account():
    """Show account information."""
    api_key, secret_key, paper = get_credentials()
    client = TradingClient(api_key, secret_key, paper=paper)
    
    account = client.get_account()
    
    print("=" * 60)
    print("  ACCOUNT INFORMATION")
    print("=" * 60)
    print()
    print(f"Account Number: {account.account_number}")
    print(f"Status: {account.status}")
    print()
    print(f"Cash: ${float(account.cash):,.2f}")
    print(f"Portfolio Value: ${float(account.portfolio_value):,.2f}")
    print(f"Buying Power: ${float(account.buying_power):,.2f}")
    print()
    print(f"Equity: ${float(account.equity):,.2f}")
    print(f"Last Equity: ${float(account.last_equity):,.2f}")
    
    pnl = float(account.equity) - float(account.last_equity)
    pnl_pct = (pnl / float(account.last_equity) * 100) if float(account.last_equity) > 0 else 0
    print(f"P&L: ${pnl:,.2f} ({pnl_pct:+.2f}%)")
    print()
    print("=" * 60)


def cmd_quote(symbols):
    """Get stock quotes."""
    api_key, secret_key, paper = get_credentials()
    data_client = StockHistoricalDataClient(api_key, secret_key)
    
    symbol_list = [s.strip().upper() for s in symbols.split(',')]
    request = StockLatestQuoteRequest(symbol_or_symbols=symbol_list)
    quotes = data_client.get_stock_latest_quote(request)
    
    print()
    print("=" * 60)
    print("  STOCK QUOTES")
    print("=" * 60)
    print()
    
    for symbol, quote in quotes.items():
        bid = f"${quote.bid_price:>8.2f}" if quote.bid_price else "$    0.00"
        ask = f"${quote.ask_price:>8.2f}" if quote.ask_price else "$    0.00"
        
        if quote.bid_price and quote.ask_price:
            mid = (quote.bid_price + quote.ask_price) / 2
            spread = quote.ask_price - quote.bid_price
        else:
            mid = quote.bid_price or 0
            spread = 0
        
        print(f"{symbol}  ")
        print(f"  Bid: {bid}  |  Ask: {ask}")
        print(f"  Mid: ${mid:>8.2f}  |  Spread: ${spread:>7.2f}")
        print(f"  Time: {quote.timestamp}")
        print()
    
    print("=" * 60)


def cmd_positions():
    """List all positions."""
    api_key, secret_key, paper = get_credentials()
    client = TradingClient(api_key, secret_key, paper=paper)
    
    positions = client.get_all_positions()
    
    print()
    print("=" * 60)
    print("  POSITIONS")
    print("=" * 60)
    print()
    
    if not positions:
        print("No open positions")
        print()
        print("=" * 60)
        return
    
    total_value = 0
    total_pnl = 0
    
    for pos in positions:
        qty = float(pos.qty)
        current_price = float(pos.current_price)
        avg_entry = float(pos.avg_entry_price)
        market_value = float(pos.market_value)
        unrealized_pl = float(pos.unrealized_pl)
        unrealized_plpc = float(pos.unrealized_plpc) * 100
        
        total_value += market_value
        total_pnl += unrealized_pl
        
        print(f"{pos.symbol}")
        print(f"  Qty: {qty:.0f}  |  Current: ${current_price:.2f}  |  Entry: ${avg_entry:.2f}")
        print(f"  Value: ${market_value:,.2f}")
        print(f"  P&L: ${unrealized_pl:+,.2f} ({unrealized_plpc:+.2f}%)")
        print()
    
    total_pnl_pct = (total_pnl / (total_value - total_pnl) * 100) if (total_value - total_pnl) > 0 else 0
    print(f"Total Portfolio Value: ${total_value:,.2f}")
    print(f"Total P&L: ${total_pnl:+,.2f} ({total_pnl_pct:+.2f}%)")
    print()
    print("=" * 60)


def cmd_orders(status='open', limit=50):
    """List orders."""
    api_key, secret_key, paper = get_credentials()
    client = TradingClient(api_key, secret_key, paper=paper)
    
    if status == 'all':
        request = GetOrdersRequest(limit=limit)
    elif status == 'open':
        request = GetOrdersRequest(status=QueryOrderStatus.OPEN, limit=limit)
    elif status == 'closed':
        request = GetOrdersRequest(status=QueryOrderStatus.CLOSED, limit=limit)
    else:
        request = GetOrdersRequest(limit=limit)
    
    orders = client.get_orders(filter=request)
    
    print()
    print("=" * 60)
    print(f"  ORDERS ({status.upper()})")
    print("=" * 60)
    print()
    
    if not orders:
        print(f"No {status} orders")
        print()
        print("=" * 60)
        return
    
    for order in orders:
        status_emoji = {
            'pending_new': '‚è≥',
            'accepted': '‚è≥',
            'new': '‚è≥',
            'partially_filled': 'üîÑ',
            'filled': '‚úì',
            'canceled': '‚úó',
            'rejected': '‚úó'
        }.get(order.status, '?')
        
        print(f"{status_emoji} {order.symbol} {order.side} {order.qty}")
        print(f"  Order ID: {order.id}")
        print(f"  Status: {order.status}")
        print(f"  Created: {order.created_at}")
        
        if order.filled_avg_price:
            print(f"  Filled Price: ${float(order.filled_avg_price):.2f}")
        
        print()
    
    print("=" * 60)


def cmd_buy(symbol, qty):
    """Place a buy order."""
    api_key, secret_key, paper = get_credentials()
    client = TradingClient(api_key, secret_key, paper=paper)
    
    order_data = MarketOrderRequest(
        symbol=symbol.upper(),
        qty=float(qty),
        side=OrderSide.BUY,
        time_in_force=TimeInForce.DAY
    )
    
    order = client.submit_order(order_data)
    
    print()
    print(f"‚úì Buy order placed: {symbol.upper()} x {qty}")
    print(f"  Order ID: {order.id}")
    print(f"  Status: {order.status}")
    print()


def cmd_sell(symbol, qty):
    """Place a sell order."""
    api_key, secret_key, paper = get_credentials()
    client = TradingClient(api_key, secret_key, paper=paper)
    
    order_data = MarketOrderRequest(
        symbol=symbol.upper(),
        qty=float(qty),
        side=OrderSide.SELL,
        time_in_force=TimeInForce.DAY
    )
    
    order = client.submit_order(order_data)
    
    print()
    print(f"‚úì Sell order placed: {symbol.upper()} x {qty}")
    print(f"  Order ID: {order.id}")
    print(f"  Status: {order.status}")
    print()


def cmd_cancel(order_id):
    """Cancel an order."""
    api_key, secret_key, paper = get_credentials()
    client = TradingClient(api_key, secret_key, paper=paper)
    
    client.cancel_order_by_id(order_id)
    print(f"\n‚úì Order {order_id} canceled\n")


def cmd_cancel_all():
    """Cancel all open orders."""
    api_key, secret_key, paper = get_credentials()
    client = TradingClient(api_key, secret_key, paper=paper)
    
    client.cancel_orders()
    print("\n‚úì All open orders canceled\n")


def cmd_close(symbol):
    """Close a position."""
    api_key, secret_key, paper = get_credentials()
    client = TradingClient(api_key, secret_key, paper=paper)
    
    client.close_position(symbol.upper())
    print(f"\n‚úì Position {symbol.upper()} closed\n")


def cmd_close_all():
    """Close all positions."""
    api_key, secret_key, paper = get_credentials()
    client = TradingClient(api_key, secret_key, paper=paper)
    
    confirm = input("Close ALL positions? (yes/no): ").strip().lower()
    if confirm == 'yes':
        client.close_all_positions(cancel_orders=True)
        print("\n‚úì All positions closed\n")
    else:
        print("\nCanceled\n")


def main():
    parser = argparse.ArgumentParser(description='Alpaca Trading CLI')
    subparsers = parser.add_subparsers(dest='command', help='Commands')
    
    # auth
    subparsers.add_parser('auth', help='Configure API credentials')
    
    # clock
    subparsers.add_parser('clock', help='Check market status')
    
    # calendar
    calendar_parser = subparsers.add_parser('calendar', help='Show market calendar')
    calendar_parser.add_argument('--days', type=int, default=30, help='Number of days to show (default: 30)')
    
    # history
    history_parser = subparsers.add_parser('history', help='Show portfolio history')
    history_parser.add_argument('--period', default='1M', help='Period: 1D, 1W, 1M, 3M, 1Y, all (default: 1M)')
    history_parser.add_argument('--timeframe', default='1D', help='Timeframe: 1Min, 5Min, 15Min, 1H, 1D (default: 1D)')
    
    # account
    subparsers.add_parser('account', help='Show account information')
    
    # quote
    quote_parser = subparsers.add_parser('quote', help='Get stock quotes')
    quote_parser.add_argument('symbols', help='Symbol(s) (comma-separated)')
    
    # positions
    subparsers.add_parser('positions', help='List all positions')
    
    # orders
    orders_parser = subparsers.add_parser('orders', help='List orders')
    orders_parser.add_argument('--status', default='open', choices=['open', 'closed', 'all'])
    orders_parser.add_argument('--limit', type=int, default=50)
    
    # buy
    buy_parser = subparsers.add_parser('buy', help='Place a buy order')
    buy_parser.add_argument('symbol', help='Stock symbol')
    buy_parser.add_argument('qty', help='Quantity')
    
    # sell
    sell_parser = subparsers.add_parser('sell', help='Place a sell order')
    sell_parser.add_argument('symbol', help='Stock symbol')
    sell_parser.add_argument('qty', help='Quantity')
    
    # cancel
    cancel_parser = subparsers.add_parser('cancel', help='Cancel an order')
    cancel_parser.add_argument('order_id', help='Order ID')
    
    # cancel-all
    subparsers.add_parser('cancel-all', help='Cancel all open orders')
    
    # close
    close_parser = subparsers.add_parser('close', help='Close a position')
    close_parser.add_argument('symbol', help='Stock symbol')
    
    # close-all
    subparsers.add_parser('close-all', help='Close all positions')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        sys.exit(1)
    
    try:
        if args.command == 'auth':
            cmd_auth()
        elif args.command == 'clock':
            cmd_clock()
        elif args.command == 'calendar':
            cmd_calendar(args.days)
        elif args.command == 'history':
            cmd_history(args.period, args.timeframe)
        elif args.command == 'account':
            cmd_account()
        elif args.command == 'quote':
            cmd_quote(args.symbols)
        elif args.command == 'positions':
            cmd_positions()
        elif args.command == 'orders':
            cmd_orders(args.status, args.limit)
        elif args.command == 'buy':
            cmd_buy(args.symbol, args.qty)
        elif args.command == 'sell':
            cmd_sell(args.symbol, args.qty)
        elif args.command == 'cancel':
            cmd_cancel(args.order_id)
        elif args.command == 'cancel-all':
            cmd_cancel_all()
        elif args.command == 'close':
            cmd_close(args.symbol)
        elif args.command == 'close-all':
            cmd_close_all()
    except KeyboardInterrupt:
        print("\n\nCanceled")
        sys.exit(0)
    except Exception as e:
        print(f"\nError: {e}\n")
        sys.exit(1)


if __name__ == '__main__':
    main()
